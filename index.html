<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Semantic evaluation of the While language via Semantic rules</title>
    <script src="js/codemirror.js"></script>
    <script src="js/while_mode.js"></script>
    <script src="js/peg-0.10.0.min.js"></script>
    <script src="js/big_step.js"></script>
    <script src="js/js.cookies.js"></script>
    <script src="libs/katex/katex.js"></script>
    <script src="libs/katex/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="css/codemirror.css"/>
    <link rel="stylesheet" type="text/css" href="libs/katex/katex.css"/>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
<script>

    _con = new Context({"a": 4});
    function compOp(op, left, right){
        switch (op){
            case "<":
                return new Lower(left, right);
            case "<=":
                return new LowerEquals(left, right);
            case ">":
                return new Greater(left, right);
            case ">=":
                return new GreaterEquals(left, right);
            case "!=":
                return new UnEquals(left, right);
            case "==":
                return new Equals(left, right);
        }
    }
    let parser = peg.generate('\
    start = _ c:Com _ {return c;};\
\
    Com \
        = Seq;\
    Seq \
        = left:subcom _ ";" _ right:Seq {return new Seq(left, right);}\
        / subcom;\
    LocalAss \
        = "{" _ "var" _ _var:Var _ ":=" _ aexp:Aexp _ ";" _ com:Com _ "}" {return new LocalAss(_var, aexp, com);};\
    subcom \
        = "skip" {return new Skip();}\
        / _var:Var _ ":=" _ aexp:Aexp {return new Ass(_var, aexp);}\
        / "if" _ "(" b:Bexp _ ")" _ "then" _ c1:Com _ "else" _ c2:Com {return new If(b, c1, c2);}\
        / "while" _ "(" _ b:Bexp _ ")" _ "do" _ c:Com {return new While(b, c)}\
        / "(" _ seq:Com _ ")" {return seq;}\
        / LocalAss;\
    Bexp = And;\
    And \
        = left:Or _ "&&" _ right:And {return new And(left, right);}\
        / Or;\
    Or \
        = left:Not _ "||" _ right:Or {return new Or(left, right);}\
        / Not;\
    Not \
        = "not" _ exp:Not {return new Not(exp);}\
        / "true" {return new Bool(true);}\
        / le;\
    le \
       = left:Aexp _ op:leop _ right:Aexp {return new compOp(op, left, right);}\
       / "(" bexp:Bexp ")" {return bexp;};\
    leop = "<=" / "<" / ">=" / ">" / "!=" / "==";\
    Aexp\
        = sub:Sub;\
\
    Sub\
        = left:Mul _ op:subop _ right:Sub { return op[0] == "-" ? new Sub(left, right) : new Add(left, right); } \
        / Mul; \
        \
    subop = "-" / "+";\
    Mul\
        = left:Atom _ op:mulop _ right:Mul { return op[0] == "*" ? new Mul(left, right) : new Div(left, right); }\
        / Atom; \
    \
    Atom\
        = int:integer {return new Num(int);} \
        / Var\
        / "(" _ aexp:Aexp _ ")" {return aexp;};\
    mulop = "*" / "/";\
    Var = _var:([a-zA-Z][a-zA-Z0-9]*) {return new Var(_var.join(""));};\
    integer\
        = digits:[0-9]+ { return parseInt(digits.join(""), 10); };\
    _ "whitespace"\
        = [ \\t\\n\\r]*;\
    ');
    /*var test = parser.parse("if  (not 1 <= 3) then {skip} else {a:=3}");
    var com = new ComEvalLine(test, _con, _con);
    var el = new EvalStep(new Rule("bla"), com, [com, com]);
console.log(el.toHTML());*/
</script>

<a href="https://github.com/parttimenerd/whilesemantic"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <div class="container">

      <div class="starter-template" style="margin-top: 1cm;">
        <h1>While Language </h1>
          <small>See <a href="http://pp.info.uni-karlsruhe.de/lehre/SS2017/semantik/semantik-skript-2017.pdf">
              course on semantics of programming languages
          </a></small>
          <div style="height: 2.5cm; border: solid darkgray 1px;">
          <textarea class="form-control" id="source" rows="3"></textarea>
          </div>
          <div style="height: 1cm; border: solid darkgray 1px; margin-bottom: 0.5cm;">
              <textarea class="form-control" id="vars" rows="3"></textarea>
          </div>
          <form class="form-inline" style="margin-bottom: 0.5cm;">
              <div class="form-group">
                  <label for="maxSteps" class="">Max steps</label>
                      <input class="form-control" type="number" value="100" id="maxSteps" onkeyup="update()">
              </div>
          </form>
      </div>

    </div>
<div class="container">
    Result: <div id="resultContext"><textarea id="resultContextTA"></textarea></div>
</div>
<div class="container" style="height: 1cm; text-align: center; "><div id="ruleApplication"></div></div>

<div style="margin-top: 0cm; margin-left: auto; margin-right: auto; padding-top: 1cm; overflow: visible; overflow-y: auto; text-align: center; height: 100%;">
        <div id="result" style="margin-left: auto; margin-right: auto; height: 100%;overflow:visible;text-align: center;"></div>
</div>

<script>
    function display(html){
        document.querySelector("#ruleApplication").innerHTML = html;
    }
    /** @param {RuleApplication} ruleApplication */
    function displayRule(ruleApplication){
        let formula = ruleApplication.toInstantiatedHTML();
        displayLaTex(formula);
    }
    function displayLaTex(formula){
        let elem = document.querySelector("#ruleApplication");
        let html = katex.renderToString(formula, {
            displayMode: true,
            macros: {
                "\\RR": "\\mathbb{R}"
            }
        });
        elem.innerHTML = html;
        renderMathInElement(elem);
    }
    function clearRule(){
        document.querySelector("#ruleApplication").innerHTML = "";
    }

    let sourceEditor = CodeMirror.fromTextArea(document.getElementById("source"), {
        mode:  "text/x-while",
        lineWrapping: true,
        matchClosing: true
    });
    sourceEditor.setSize("100%","100%");
    sourceEditor.setValue((Cookies.get("source") || "").length < 1 ? "if (a<=2) then skip else a:=4" : Cookies.get("source"))
    let varsEditor = CodeMirror.fromTextArea(document.getElementById("vars"), {
        mode:  "text/x-while",
        lineWrapping: true
    });
    varsEditor.setSize("100%","100%");
    varsEditor.setValue((Cookies.get("vars") || "").length < 1 ? "a -> 5" : Cookies.get("vars"));
    let resultContextEditor = CodeMirror.fromTextArea(document.getElementById("resultContextTA"), {
        mode:  "text/x-while",
        lineWrapping: true,
        readOnly: true
    });
    document.getElementById("maxSteps").value = isNaN(Number(Cookies.get("maxSteps"))) ? 100 : Cookies.get("maxSteps");
    resultContextEditor.setSize("90%","90%");
    sourceEditor.on("change", function() {
        update();
    });
    varsEditor.on("change", function() {
        update();
    });
    update();
    function update(){
        let text = sourceEditor.getValue();
        try {
            let maxSteps = Number.parseInt(document.getElementById("maxSteps").value);
            let contextFactory = new ContextFactory();
            let con = contextFactory.createFromString(varsEditor.getValue());
            let parsed = parser.parse(text.trim());
            let result = new EvalBigSemantic(parsed, con, maxSteps).eval();
            document.getElementById("result").innerHTML = result.toHTML();
            resultContextEditor.setValue(result.currentEvalLine.endState.toValueHTML())
            Cookies.set("source", text);
            Cookies.set("maxSteps", maxSteps);
            Cookies.set("vars", varsEditor.getValue());
        } catch (e){
            console.error(e);
            resultContextEditor.setValue(e instanceof Error ? e.message : e)
        }
        // let resultST = new EvalSmallSemantic(parsed, con, maxSteps).eval();
        // document.getElementById("resultST").innerHTML = resultST.toHTML()
    }
    //console.log(parser.parse("if(not 1 <= 3) then (skip) else (a:=3)"))
</script>
</body>
</html>